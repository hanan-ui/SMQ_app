{% extends "base.html" %}

{% block content %}
<div class="mt-3"> 
    <a href="{{ url_for('gestion_references', champ_id=reference['champ_id']) }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Retour aux références
    </a>
</div>


<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">Informations de la référence</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Référence:</strong> {{ reference.domaine_code }}.{{ reference.champ_code }}.{{ reference.code }}</p>
                <p><strong>Titre:</strong> {{ reference.titre }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Domaine:</strong> {{ reference.domaine_code }} - {{ reference.domaine_titre }}</p>
                <p><strong>Champ:</strong> {{ reference.champ_code }} - {{ reference.champ_titre }}</p>
            </div>
        </div>
        {% if reference.description %}
        <p><strong>Description:</strong> {{ reference.description }}</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Formulaire du Journal de Qualité</h5>
    </div>
    <div class="card-body">
        <form method="POST">
            <!-- 1. Informations de base -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="border-bottom pb-2">1. Informations de base</h5>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="faculte" class="form-label">Faculté *</label>
                        <input type="text" class="form-control" id="faculte" name="faculte" 
                               value="{{ journal.faculte if journal else 'Faculté Polydisciplinaire de Ouarzazate' }}" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label for="periode_debut" class="form-label">Période début *</label>
                        <input type="date" class="form-control" id="periode_debut" name="periode_debut" 
                               value="{{ journal.periode_debut if journal else '' }}" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label for="periode_fin" class="form-label">Période fin *</label>
                        <input type="date" class="form-control" id="periode_fin" name="periode_fin" 
                               value="{{ journal.periode_fin if journal else '' }}" required>
                    </div>
                </div>
            </div>

            <!-- 2. Objectifs et Engagement Qualité -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="border-bottom pb-2">2. Objectifs et Engagement Qualité</h5>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Objectifs *</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" name="objectifs[]" placeholder="Ajouter un objectif" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="addInput(this, 'objectifs')">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div id="objectifs-container">
                            {% if journal and journal.objectifs %}
                                {% for objectif in journal.objectifs %}
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" name="objectifs[]" value="{{ objectif }}" required>
                                    <button type="button" class="btn btn-outline-danger" onclick="removeInput(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Engagements *</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" name="engagements[]" placeholder="Ajouter un engagement" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="addInput(this, 'engagements')">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div id="engagements-container">
                            {% if journal and journal.engagements %}
                                {% for engagement in journal.engagements %}
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" name="engagements[]" value="{{ engagement }}" required>
                                    <button type="button" class="btn btn-outline-danger" onclick="removeInput(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Actions de Suivi et d'Amélioration -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="border-bottom pb-2">3. Actions de Suivi et d'Amélioration</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addActionSuivi()">
                        <i class="bi bi-plus"></i> Ajouter une action
                    </button>
                </div>
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="actions-table">
                            <thead class="table-light">
                                <tr>
                                    <th width="120px">Date</th>
                                    <th>Processus concerné</th>
                                    <th>Description de l'action</th>
                                    <th>Responsable</th>
                                    <th width="150px">Statut</th>
                                    <th width="80px">Action</th>
                                </tr>
                            </thead>
                            <tbody id="actions-body">
                                {% if journal and journal.actions_suivi %}
                                    {% for action in journal.actions_suivi %}
                                    <tr>
                                        <td><input type="date" class="form-control form-control-sm" name="actions_date[]" value="{{ action.date }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="actions_processus[]" value="{{ action.processus }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="actions_description[]" value="{{ action.description }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="actions_responsable[]" value="{{ action.responsable }}"></td>
                                        <td>
                                            <select class="form-select form-select-sm" name="actions_statut[]">
                                                <option value="planifié" {% if action.statut == 'planifié' %}selected{% endif %}>Planifié</option>
                                                <option value="en cours" {% if action.statut == 'en cours' %}selected{% endif %}>En cours</option>
                                                <option value="terminé" {% if action.statut == 'terminé' %}selected{% endif %}>Terminé</option>
                                                <option value="abandonné" {% if action.statut == 'abandonné' %}selected{% endif %}>Abandonné</option>
                                            </select>
                                        </td>
                                        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td><input type="date" class="form-control form-control-sm" name="actions_date[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="actions_processus[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="actions_description[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="actions_responsable[]"></td>
                                    <td>
                                        <select class="form-select form-select-sm" name="actions_statut[]">
                                            <option value="planifié">Planifié</option>
                                            <option value="en cours">En cours</option>
                                            <option value="terminé">Terminé</option>
                                            <option value="abandonné">Abandonné</option>
                                        </select>
                                    </td>
                                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. Non-Conformités et Actions Correctives -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="border-bottom pb-2">4. Non-Conformités et Actions Correctives</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addNonConformite()">
                        <i class="bi bi-plus"></i> Ajouter une non-conformité
                    </button>
                </div>
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="nc-table">
                            <thead class="table-light">
                                <tr>
                                    <th width="120px">Date</th>
                                    <th>Description de la non-conformité</th>
                                    <th>Cause identifiée</th>
                                    <th>Action corrective</th>
                                    <th>Responsable</th>
                                    <th width="150px">Statut</th>
                                    <th width="80px">Action</th>
                                </tr>
                            </thead>
                            <tbody id="nc-body">
                                {% if journal and journal.non_conformites %}
                                    {% for nc in journal.non_conformites %}
                                    <tr>
                                        <td><input type="date" class="form-control form-control-sm" name="nc_date[]" value="{{ nc.date }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="nc_description[]" value="{{ nc.description }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="nc_cause[]" value="{{ nc.cause }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="nc_action[]" value="{{ nc.action }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="nc_responsable[]" value="{{ nc.responsable }}"></td>
                                        <td>
                                            <select class="form-select form-select-sm" name="nc_statut[]">
                                                <option value="ouvert" {% if nc.statut == 'ouvert' %}selected{% endif %}>Ouvert</option>
                                                <option value="en traitement" {% if nc.statut == 'en traitement' %}selected{% endif %}>En traitement</option>
                                                <option value="résolu" {% if nc.statut == 'résolu' %}selected{% endif %}>Résolu</option>
                                                <option value="fermé" {% if nc.statut == 'fermé' %}selected{% endif %}>Fermé</option>
                                            </select>
                                        </td>
                                        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td><input type="date" class="form-control form-control-sm" name="nc_date[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="nc_description[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="nc_cause[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="nc_action[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="nc_responsable[]"></td>
                                    <td>
                                        <select class="form-select form-select-sm" name="nc_statut[]">
                                            <option value="ouvert">Ouvert</option>
                                            <option value="en traitement">En traitement</option>
                                            <option value="résolu">Résolu</option>
                                            <option value="fermé">Fermé</option>
                                        </select>
                                    </td>
                                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. Indicateurs de Performance -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="border-bottom pb-2">5. Indicateurs de Performance</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addIndicateur()">
                        <i class="bi bi-plus"></i> Ajouter un indicateur
                    </button>
                </div>
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="indicateurs-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Indicateur</th>
                                    <th width="120px">Valeur cible</th>
                                    <th width="120px">Valeur actuelle</th>
                                    <th>Analyse</th>
                                    <th width="80px">Action</th>
                                </tr>
                            </thead>
                            <tbody id="indicateurs-body">
                                {% if journal and journal.indicateurs %}
                                    {% for indicateur in journal.indicateurs %}
                                    <tr>
                                        <td><input type="text" class="form-control form-control-sm" name="indicateurs_nom[]" value="{{ indicateur.nom }}"></td>
                                        <td><input type="number" step="0.01" class="form-control form-control-sm" name="indicateurs_cible[]" value="{{ indicateur.cible }}"></td>
                                        <td><input type="number" step="0.01" class="form-control form-control-sm" name="indicateurs_actuel[]" value="{{ indicateur.actuel }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="indicateurs_analyse[]" value="{{ indicateur.analyse }}"></td>
                                        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td><input type="text" class="form-control form-control-sm" name="indicateurs_nom[]"></td>
                                    <td><input type="number" step="0.01" class="form-control form-control-sm" name="indicateurs_cible[]"></td>
                                    <td><input type="number" step="0.01" class="form-control form-control-sm" name="indicateurs_actuel[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="indicateurs_analyse[]"></td>
                                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 6. Revues et Décisions -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="border-bottom pb-2">6. Revues et Décisions</h5>
                </div>
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label for="revue_date" class="form-label">Date de la revue</label>
                        <input type="date" class="form-control" id="revue_date" name="revue_date" 
                               value="{{ journal.revues_decision.date if journal and journal.revues_decision }}">
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="form-group mb-3">
                        <label for="revue_participants" class="form-label">Participants</label>
                        <input type="text" class="form-control" id="revue_participants" name="revue_participants" 
                               value="{{ journal.revues_decision.participants if journal and journal.revues_decision }}" 
                               placeholder="Noms des participants séparés par des virgules">
                    </div>
                </div>
                <div class="col-12">
                    <div class="form-group mb-3">
                        <label for="revue_decisions" class="form-label">Décisions prises</label>
                        <textarea class="form-control" id="revue_decisions" name="revue_decisions" rows="3" 
                                  placeholder="Décrivez les décisions prises lors de la revue...">{% if journal and journal.revues_decision %}{{ journal.revues_decision.decisions }}{% endif %}</textarea>
                    </div>
                </div>
            </div>

            <!-- 7. Plans d'Amélioration Continue -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="border-bottom pb-2">7. Plans d'Amélioration Continue</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addPlanAmelioration()">
                        <i class="bi bi-plus"></i> Ajouter un plan
                    </button>
                </div>
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="plans-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Action</th>
                                    <th>Objectif</th>
                                    <th>Responsable</th>
                                    <th width="120px">Délai</th>
                                    <th width="80px">Action</th>
                                </tr>
                            </thead>
                            <tbody id="plans-body">
                                {% if journal and journal.plans_amelioration %}
                                    {% for plan in journal.plans_amelioration %}
                                    <tr>
                                        <td><input type="text" class="form-control form-control-sm" name="plan_action[]" value="{{ plan.action }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="plan_objectif[]" value="{{ plan.objectif }}"></td>
                                        <td><input type="text" class="form-control form-control-sm" name="plan_responsable[]" value="{{ plan.responsable }}"></td>
                                        <td><input type="date" class="form-control form-control-sm" name="plan_delai[]" value="{{ plan.delai }}"></td>
                                        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td><input type="text" class="form-control form-control-sm" name="plan_action[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="plan_objectif[]"></td>
                                    <td><input type="text" class="form-control form-control-sm" name="plan_responsable[]"></td>
                                    <td><input type="date" class="form-control form-control-sm" name="plan_delai[]"></td>
                                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 8. Observations générales -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="border-bottom pb-2">8. Observations générales</h5>
                </div>
                <div class="col-12">
                    <div class="form-group mb-3">
                        <textarea class="form-control" id="observations" name="observations" rows="4" 
                                  placeholder="Ajoutez ici vos observations générales...">{% if journal %}{{ journal.observations }}{% endif %}</textarea>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{{ url_for('journal', reference_id=reference.id) }}" class="btn btn-secondary me-md-2">
                    Annuler
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> {% if journal %}Modifier{% else %}Créer{% endif %} le journal
                </button>
            </div>
        </form>
    </div>
</div>

{% block scripts %}
<script>
function addInput(button, type) {
    const container = document.getElementById(type + '-container');
    const newInput = document.createElement('div');
    newInput.className = 'input-group mb-2';
    newInput.innerHTML = `
        <input type="text" class="form-control" name="${type}[]" placeholder="Ajouter un ${type === 'objectifs' ? 'objectif' : 'engagement'}" required>
        <button type="button" class="btn btn-outline-danger" onclick="removeInput(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    container.appendChild(newInput);
}

function removeInput(button) {
    button.parentElement.remove();
}

function addActionSuivi() {
    const tbody = document.getElementById('actions-body');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="date" class="form-control form-control-sm" name="actions_date[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="actions_processus[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="actions_description[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="actions_responsable[]"></td>
        <td>
            <select class="form-select form-select-sm" name="actions_statut[]">
                <option value="planifié">Planifié</option>
                <option value="en cours">En cours</option>
                <option value="terminé">Terminé</option>
                <option value="abandonné">Abandonné</option>
            </select>
        </td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
    `;
    tbody.appendChild(newRow);
}

function addNonConformite() {
    const tbody = document.getElementById('nc-body');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="date" class="form-control form-control-sm" name="nc_date[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="nc_description[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="nc_cause[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="nc_action[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="nc_responsable[]"></td>
        <td>
            <select class="form-select form-select-sm" name="nc_statut[]">
                <option value="ouvert">Ouvert</option>
                <option value="en traitement">En traitement</option>
                <option value="résolu">Résolu</option>
                <option value="fermé">Fermé</option>
            </select>
        </td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
    `;
    tbody.appendChild(newRow);
}

function addIndicateur() {
    const tbody = document.getElementById('indicateurs-body');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="text" class="form-control form-control-sm" name="indicateurs_nom[]"></td>
        <td><input type="number" step="0.01" class="form-control form-control-sm" name="indicateurs_cible[]"></td>
        <td><input type="number" step="0.01" class="form-control form-control-sm" name="indicateurs_actuel[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="indicateurs_analyse[]"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
    `;
    tbody.appendChild(newRow);
}

function addPlanAmelioration() {
    const tbody = document.getElementById('plans-body');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="text" class="form-control form-control-sm" name="plan_action[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="plan_objectif[]"></td>
        <td><input type="text" class="form-control form-control-sm" name="plan_responsable[]"></td>
        <td><input type="date" class="form-control form-control-sm" name="plan_delai[]"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
    `;
    tbody.appendChild(newRow);
}

function removeRow(button) {
    button.closest('tr').remove();
}
</script>
{% endblock %}
{% endblock %}